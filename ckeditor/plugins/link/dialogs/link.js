var update_ckgeditInternalLink,update_ckgeditMediaLink;var fckgInternalInputId,fckgMediaInputId;window.onbeforeunload=function(){};CKEDITOR.dialog.add("link",function(b){oDokuWiki_FCKEditorInstance.Lang=b.lang;var w=oDokuWiki_FCKEditorInstance.dwiki_doku_base;var Q=CKEDITOR.plugins.link;var f=new Object();f.doku_base=new RegExp("^"+w.replace(/\//g,"\\/"),"g");f.media_internal=/lib\/exe\/fetch\.php\/(.*)/;f.media_rewrite_1=/^_media\/(.*)/;f.media_rewrite_1Doku_Base=new RegExp("^"+w+"_media/(.*)");f.media_rewrite_2=/exe\/fetch.php\?media=(.*)/;f.internal_link=/doku.php\?id=(.*)/;f.internal_link_rewrite_2=/doku.php\/(.*)/;f.internal_link_rewrite_1=new RegExp("^"+w+"(?!_media)(.*)");f.samba=/file:\/\/\/\/\/(.*)/;f.samba_unsaved=/^\\\\\w+(\\\w.*)/;var p=oDokuWiki_FCKEditorInstance.mfiles?["m-files://\u200E",""]:"";var A;var G={InternalLink:"internal link",InternalMedia:"internal media",MediaFileLink:"link to media file",SMBLabel:"Samba Share",GetHeadingsLabel:"Get Headings",QStringLabel:"Query String (For example: value_1=1&value_2=2) ",ResetQS:"Reset Query String",NotSetOption:"Not Set",AdvancedInfo:"To create anchors from Dokuwiki headers, click on the Get Headings button, select the header, click OK. You can go back, select a new page and get new headers.",AdvancedTabPrompt:"Use the advanced tab to create page anchors and query strings",SMBExample:"Enter your share as: \\\\Server\\directory\\file"};var q=b.lang.fbrowser?b.lang.fbrowser:G;var j=function(T){if(q[T]&&q[T]!=""){return q[T]}return G[T]};var N=function(){var W=this.getDialog();var Y=W.getContentElement("advanced","internalAnchor").getInputElement().$.id;var T=document.getElementById(Y);var V=W.getContentElement("info","internal").getInputElement().$.id;V=document.getElementById(V).value;if(!V){return}var U={push:function(aa,Z){this.stack[this.Index]=(new Option(aa,Z,false,false));this.Index++},Index:0,stack:undefined,selection:"",ini:function(Z){this.stack=T.options;this.stack.length=0;this.Index=0;this.push(Z,"")}};var X="dw_id="+V;b.config.jquery.post(b.config.ckedit_path+"get_headers.php",X,function(ad,Z){if(Z=="success"){var ae=decodeURIComponent(ad);if(ae.match(/^\s*__EMPTY__\s*$/)){U.ini("No Headers Found");U.selection="";return}U.ini("Headings Menu");var ac=ae.split("@@");for(var ab in ac){var aa=ac[ab].split(/;;/);U.push(aa[0],aa[1])}}},"html")};var J=function(U){var V=U;var T=0;var W="dw_id="+encodeURIComponent(U);b.config.jquery.ajax({url:b.config.ckedit_path+"useheading.php",async:false,data:W,type:"POST",dataType:"html",success:function(X){if(T){alert(X)}V=decodeURIComponent(X)},error:function(X,Z,Y){V=U}});return V};var R=function(){return A};var m=function(){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=false;oDokuWiki_FCKEditorInstance.isUrlExtern=false;oDokuWiki_FCKEditorInstance.isDwikiMediaFile=false;var W=this.getDialog(),Z=["urlOptions","anchorOptions","emailOptions","internalOptions","mediaOptions","sambaOptions"],Y=this.getValue(),X=W.definition.getContents("upload"),T=X&&X.hidden;W.hidePage("advanced");if(Y=="internal"){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=true;W.showPage("advanced")}else{if(Y=="media"){oDokuWiki_FCKEditorInstance.isDwikiMediaFile=true}}if(Y=="url"){oDokuWiki_FCKEditorInstance.isUrlExtern=true;if(!T){W.showPage("upload")}}else{if(!T){W.hidePage("upload")}}for(var V=0;V<Z.length;V++){var U=W.getContentElement("info",Z[V]);if(!U){continue}U=U.getElement().getParent().getParent();if(Z[V]==Y+"Options"){U.show()}else{U.hide()}}W.layout()};var I=/^javascript:/,K=/^mailto:([^?]+)(?:\?(.+))?$/,h=/subject=([^;?:@&=$,\/]*)/,S=/body=([^;?:@&=$,\/]*)/,t=/^#(.*)$/,c=/^((?:http|https|ftp|news):\/\/)?(.*)$/,u=/^(_(?:self|top|parent|blank))$/,o=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,F=/^javascript:([^(]+)\(([^)]+)\)$/;var a=/doku.php\?id=(.*)$/;var l=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/;var y=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var n=function(aa,X){var U=(X&&(X.data("cke-saved-href")||X.getAttribute("href")))||"",ad,Z,Y,W,V={};if((ad=U.match(I))){if(k=="encode"){U=U.replace(o,function(ag,ai,ah){return"mailto:"+String.fromCharCode.apply(String,ai.split(","))+(ah&&s(ah))})}else{if(k){U.replace(F,function(am,ao,aj){if(ao==H.name){V.type="email";var an=V.email={};var ah=/[^,\s]+/g,ai=/(^')|('$)/g,ag=aj.match(ah),ap=ag.length,al,aq;for(var ak=0;ak<ap;ak++){aq=decodeURIComponent(s(ag[ak].replace(ai,"")));al=H.params[ak].toLowerCase();an[al]=aq}an.address=[an.name,an.domain].join("@")}})}}}if(!V.type){if((Y=U.match(t))){V.type="anchor";V.anchor={};V.anchor.name=V.anchor.id=Y[1]}else{if((Z=U.match(K))){var af=U.match(h),T=U.match(S);V.type="email";var ac=(V.email={});ac.address=Z[1];af&&(ac.subject=decodeURIComponent(af[1]));T&&(ac.body=decodeURIComponent(T[1]))}else{if((W=U.match(f.media_internal))||(W=U.match(f.media_rewrite_1))||(W=U.match(f.media_rewrite_2))||(W=U.match(f.media_rewrite_1Doku_Base))){V.type="media";V.url={};V.url.protocol="";V.url.url="";V.url.selected=W[1]}else{if((W=U.match(a))||(W=U.match(f.internal_link_rewrite_2))||(W=U.match(f.internal_link_rewrite_1))){V.type="internal";V.url={};V.url.selected=W[1];V.url.protocol="";V.url.url=""}else{if(W=U.match(f.samba)){V.type="samba";V.url={};V.url.url="";V.url.protocol="";V.url.selected="\\\\"+W[1].replace(/\//g,"\\")}else{if(W=U.match(f.samba_unsaved)){V.type="samba";V.url={};V.url.url="";V.url.protocol="";V.url.selected=W[0]}else{if(U&&(W=U.match(c))){V.type="url";V.url={};V.url.protocol=W[1];V.url.url=W[2]}else{V.type="url"}}}}}}}}if(X){var ab=X.getAttribute("target");V.target={};V.adv={};var ae=this}this._.selectedElement=X;return V};var B=function(T){if(!T){return}T=T.replace(/^[\/\:]/,"");T=T.replace(/\//g,":");T=":"+T;document.getElementById(fckgInternalInputId).value=T};update_ckgeditInternalLink=B;var d=function(T){if(!T){return}T=T.replace(/^[\/\:]/,"");T=T.replace(/\//g,":");T=":"+T;document.getElementById(fckgMediaInputId).value=T};update_ckgeditMediaLink=d;var r=function(T){for(i in T){msg=i+"="+T[i];if(!confirm(msg)){break}}};var x=function(U,T){if(T[U]){this.setValue(T[U][this.id]||"")}};var M=function(T){return x.call(this,"target",T)};var L=function(T){return x.call(this,"adv",T)};var O=function(U,T){if(!T[U]){T[U]={}}T[U][this.id]=this.getValue()||""};var z=function(T){return O.call(this,"target",T)};var P=function(T){return O.call(this,"adv",T)};function s(T){return T.replace(/\\'/g,"'")}function C(T){return T.replace(/'/g,"\\$&")}var k=b.config.emailProtection||"";if(k&&k!="encode"){var H={};k.replace(/^([^(]+)\(([^)]+)\)$/,function(T,U,V){H.name=U;H.params=[];V.replace(/[^,\s]+/g,function(W){H.params.push(W)})})}function e(V){var T,U=H.name,Z=H.params,X,Y;T=[U,"("];for(var W=0;W<Z.length;W++){X=Z[W].toLowerCase();Y=V[X];W>0&&T.push(",");T.push("'",Y?C(encodeURIComponent(V[X])):"","'")}T.push(")");return T.join("")}function v(U){var T,X=U.length,V=[];for(var W=0;W<X;W++){T=U.charCodeAt(W);V.push(T)}return"String.fromCharCode("+V.join(",")+")"}function E(U){var T=U.getAttribute("class");return T?T.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var D=b.lang.common,g=b.lang.link;return{title:g.title,minWidth:375,minHeight:250,contents:[{id:"info",label:g.info,title:g.info,elements:[{id:"linkType",type:"select",label:g.type,"default":"url",items:[[g.toUrl,"url"],[j("InternalLink"),"internal"],[j("InternalMedia"),"media"],[g.toEmail,"email"],["Samba share","samba"]],onChange:m,setup:function(T){if(T.type){this.setValue(T.type)}},commit:function(T){T.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:D.protocol,"default":"http://",items:[["http://\u200E","http://"],["https://\u200E","https://"],["ftp://\u200E","ftp://"],["news://\u200E","news://"],p],setup:function(T){if(T.url){this.setValue(T.url.protocol||"")}},commit:function(T){if(!T.url){T.url={}}T.url.protocol=this.getValue()}},{type:"text",id:"url",label:D.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var V=this.getDialog().getContentElement("info","protocol"),T=this.getValue(),U=/^(http|https|ftp|news):\/\/(?=.)/i,X=/^((javascript:)|[#\/\.\?])/i;var W=U.exec(T);if(W){this.setValue(T.substr(W[0].length));V.setValue(W[0].toLowerCase())}else{if(X.test(T)){V.setValue("")}}this.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var T=this.getDialog();if(T.getContentElement("info","linkType")&&T.getValueOf("info","linkType")!="url"){return true}if(this.getDialog().fakeObj){return true}var U=CKEDITOR.dialog.validate.notEmpty(g.noUrl);return U.apply(this)},setup:function(T){this.allowOnChange=false;if(T.url){this.setValue(T.url.url)}this.allowOnChange=true},commit:function(T){this.onChange();if(!T.url){T.url={}}T.url.url=this.getValue();this.allowOnChange=false}}],setup:function(T){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().show()}}}]},{type:"vbox",id:"internalOptions",children:[{type:"button",id:"browse1",hidden:"true",filebrowser:"info:url",label:D.browseServer},{type:"text",id:"internal",label:j("InternalLink"),required:true,setup:function(T){if(T){if(T.url&&T.url.selected){var U=T.url.selected.replace(/^\:/,"");this.setValue(":"+U)}}}},{id:"anchorsmsg",type:"html",html:j("AdvancedTabPrompt")}]},{type:"vbox",id:"mediaOptions",children:[{type:"button",id:"browse2",filebrowser:"info:url",label:D.browseServer},{type:"text",id:"media",label:j("MediaFileLink"),required:true,setup:function(T){if(T){if(T.url&&T.url.selected){var U=T.url.selected.replace(/^\:/,"");this.setValue(":"+U)}}}}]},{type:"vbox",id:"sambaOptions",children:[{type:"html",id:"smb_msg",html:j("SMBExample")},{type:"text",id:"samba",width:"50",label:j("SMBLabel"),required:true,setup:function(T){if(T.url&&T.url.selected){this.setValue(T.url.selected)}}}]},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:g.emailAddress,required:true,validate:function(){var T=this.getDialog();if(!T.getContentElement("info","linkType")||T.getValueOf("info","linkType")!="email"){return true}var U=CKEDITOR.dialog.validate.notEmpty(g.noEmail);return U.apply(this)},setup:function(U){if(U.email){this.setValue(U.email.address)}var T=this.getDialog().getContentElement("info","linkType");if(T&&T.getValue()=="email"){this.select()}},commit:function(T){if(!T.email){T.email={}}T.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:g.emailSubject,setup:function(T){if(T.email){this.setValue(T.email.subject)}},commit:function(T){if(!T.email){T.email={}}T.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:g.emailBody,rows:3,"default":"",setup:function(T){if(T.email){this.setValue(T.email.body)}},commit:function(T){if(!T.email){T.email={}}T.email.body=this.getValue()}}],setup:function(T){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}}]},{id:"upload",label:g.upload,title:g.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:D.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:D.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:g.advanced,title:g.advanced,elements:[{id:"msg",type:"html",html:"<p style='max-width:350px; white-space: pre-wrap;'>"+j("AdvancedInfo")+"</p>"},{id:"internalAnchor",type:"select","default":"",items:[["Not Set",""]],setup:function(T){if(T.hash){this.setValue(T.hash)}},commit:function(T){T.hash=this.getValue()}},{type:"button",id:"getheaders",onClick:N,label:j("GetHeadingsLabel")},{type:"html",html:"<br />"},{type:"text",id:"queryString",label:j("QStringLabel"),setup:function(T){if(T.qstring){this.setValue(T.qstring)}},commit:function(T){T.qstring=this.getValue()}},{type:"button",id:"clearquerystring",onClick:function(){var U=this.getDialog();var V=U.getContentElement("advanced","queryString").getInputElement().$.id;var T=document.getElementById(V);T.value=""},label:j("ResetQS")},{type:"vbox",padding:1,hidden:true,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:g.cssClasses,"default":"",id:"advCSSClasses",setup:L,commit:P},{type:"text",label:g.charset,"default":"",id:"advCharset",setup:L,commit:P}]}]}]}],onShow:function(){var V=this.getParentEditor(),U=V.getSelection(),T=null;if((T=Q.getSelectedLink(V))&&T.hasAttribute("href")){U.selectElement(T)}else{T=null}this.setupContent(n.apply(this,[V,T]))},onOk:function(){var ad=new RegExp(oDokuWiki_FCKEditorInstance.imageUploadAllowedExtensions);var af={},Y=[],aw={},av=this,aa=this.getParentEditor();this.commitContent(aw);var aq=false;var ag="";switch(aw.type||"url"){case"media":if(document.getElementById(fckgMediaInputId).value){aw.url.url=document.getElementById(fckgMediaInputId).value}aw.adv.advTitle=aw.url.url;var au=aw.url.url.match(/(\.(\w+))$/);ag=aw.url.url.replace(/^:/,"");aw.url.url=top.dokuBase+"doku.php?id="+aw.url.url;if(au[1].match(ad)){aw.adv.advContentType="linkonly"}else{aw.adv.advContentType="other_mime";aw.url.url=top.dokuBase+"lib/exe/fetch.php?media="+ag;aq=true}aw.adv.advCSSClasses="media mediafile";if(au){aw.adv.advCSSClasses+=" mf_"+au[2]}var al=(aw.url&&aw.url.protocol!=undefined)?aw.url.protocol:"http://",ab=(aw.url&&CKEDITOR.tools.trim(aw.url.url))||"";af["data-cke-saved-href"]=(ab.indexOf("/")===0)?ab:al+ab;break;case"internal":if(!aw.url.url){aw.url.url=document.getElementById(fckgInternalInputId).value;if(!aw.url.url.match(/^:?\w+:/)){var ay=top.getCurrentWikiNS()+":";ay=ay.replace(/:$/,"");var X=new RegExp(":?"+ay+":");if(!aw.url.url.match(X)){aw.url.url=ay+":"+aw.url.url;aw.url.url=aw.url.url.replace(/\:{2,}/g,":")}}}aw.url.url=aw.url.url.replace(/^.*?\/data\/pages\//,"");aw.url.url=aw.url.url.replace(/^\:/,"");aw.url.url=":"+aw.url.url.replace(/\//g,":");aw.adv.advCSSClasses="wikilink1";if(oDokuWiki_FCKEditorInstance.useheading=="y"){aw.adv.advTitle=J(aw.url.url)}else{aw.adv.advTitle=aw.url.url}aw.url.url=top.dokuBase+"doku.php?id="+aw.url.url;if(aw.hash){aw.url.url+="#"+aw.hash}if(aw.qstring){aw.url.url+="&"+aw.qstring}case"url":var al=(aw.url&&aw.url.protocol!=undefined)?aw.url.protocol:"http://",ab=(aw.url&&CKEDITOR.tools.trim(aw.url.url))||"";af["data-cke-saved-href"]=(ab.indexOf("/")===0)?ab:al+ab;break;case"anchor":var az=(aw.anchor&&aw.anchor.name),am=(aw.anchor&&aw.anchor.id);af["data-cke-saved-href"]="#"+(az||am||"");break;case"samba":if(!aw.url.url){aw.url.url=document.getElementById(R()).value}if(!aw.url.url){alert("Missing Samba Url");return false}aw.url.protocol="";var al="";ab=(aw.url&&CKEDITOR.tools.trim(aw.url.url))||"";af["data-cke-saved-href"]=(ab.indexOf("/")===0)?ab:al+ab;aw.adv.advCSSClasses="windows";aw.adv.advTitle=aw.url.url;break;case"email":var W,ao=aw.email,Z=ao.address;switch(k){case"":case"encode":var ac=encodeURIComponent(ao.subject||""),ah=encodeURIComponent(ao.body||"");var ae=[];ah&&ae.push("body="+ah);ac&&ae.push("subject="+ac);ae=ae.length?"?"+ae.join("&"):"";if(k=="encode"){W=["javascript:void(location.href='mailto:'+",v(Z)];ae&&W.push("+'",C(ae),"'");W.push(")")}else{W=["mailto:",Z,ae]}break;default:var an=Z.split("@",2);ao.name=an[0];ao.domain=an[1];W=["javascript:",e(ao)]}af["data-cke-saved-href"]=W.join("");break}if(aw.adv){var ap=function(aA,aB){var aC=aw.adv[aA];if(aC){af[aB]=aC}else{Y.push(aB)}};ap("advId","id");ap("advLangDir","dir");ap("advAccessKey","accessKey");if(aw.adv.advName){af.name=af["data-cke-saved-name"]=aw.adv.advName}else{Y=Y.concat(["data-cke-saved-name","name"])}ap("advLangCode","lang");ap("advTabIndex","tabindex");if(!aq){ap("advTitle","title")}ap("advContentType","type");ap("advCSSClasses","class");ap("advCharset","charset");ap("advStyles","style");ap("advRel","rel")}var ax=aa.getSelection();var ak=ax.getSelectedText()?ax.getSelectedText():false;af.href=af["data-cke-saved-href"];if(!this._.selectedElement){var V=ax.getRanges(true);if(V.length==1&&V[0].collapsed){var aj=new CKEDITOR.dom.text(aw.type=="email"?aw.email.address:af["data-cke-saved-href"],aa.document);V[0].insertNode(aj);V[0].selectNodeContents(aj);ax.selectRanges(V)}if(navigator.userAgent.match(/(Trident|MSIE)/)){var T=aa.document.createElement("a");T.setAttribute("href",af.href);if(!ak&&(aw.type=="media"||aw.type=="internal")){T.setHtml(aw.adv.advTitle)}else{T.setHtml(ax.getSelectedText())}for(attr in af){if(attr.match(/href/i)){continue}T.setAttribute(attr,af[attr])}aa.insertElement(T)}else{var at=new CKEDITOR.style({element:"a",attributes:af});at.type=CKEDITOR.STYLE_INLINE;at.apply(aa.document)}}else{var U=this._.selectedElement,ar=U.data("cke-saved-href"),ai=U.getHtml();if(aq){af.type="other_mime";af.title=":"+ag}U.setAttributes(af);U.removeAttributes(Y);if(aw.adv&&aw.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector){U.addClass(U.getChildCount()?"cke_anchor":"cke_anchor_empty")}if(ar==ai||aw.type=="email"&&ai.indexOf("@")!=-1){U.setHtml(aw.type=="email"?aw.email.address:af["data-cke-saved-href"])}ax.selectElement(U);delete this._.selectedElement}if(aj&&aw.adv.advTitle){aj.setText(aw.adv.advTitle)}},onLoad:function(){oDokuWiki_FCKEditorInstance.isDwikiImage=false;fckgInternalInputId=this.getContentElement("info","internal").getInputElement().$.id;fckgMediaInputId=this.getContentElement("info","media").getInputElement().$.id;A=this.getContentElement("info","samba").getInputElement().$.id;this.hidePage("advanced");this.showPage("info");var U=this._.tabs.advanced&&this._.tabs.advanced[0];var T=this;var V=j("NotSetOption");U.on("focus",function(X){var Y=T.getContentElement("advanced","internalAnchor").getInputElement().$.id;var W=document.getElementById(Y);W.selectedIndex=-1;W.options.length=0;W.options[0]=new Option(V,"",false,false)})},onFocus:function(){var T=this.getContentElement("info","linkType"),U;if(T&&T.getValue()=="url"){U=this.getContentElement("info","url");U.select()}}}});