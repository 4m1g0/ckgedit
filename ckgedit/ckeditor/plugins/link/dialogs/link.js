var update_ckgeditInternalLink,update_ckgeditMediaLink;var fckgInternalInputId,fckgMediaInputId;window.onbeforeunload=function(){};CKEDITOR.dialog.add("link",function(b){oDokuWiki_FCKEditorInstance.Lang=b.lang;var v=oDokuWiki_FCKEditorInstance.dwiki_doku_base;var N=CKEDITOR.plugins.link;var f=new Object();f.doku_base=new RegExp("^"+v.replace(/\//g,"\\/"),"g");f.media_internal=/lib\/exe\/fetch\.php\/(.*)/;f.media_rewrite_1=/^_media\/(.*)/;f.media_rewrite_1Doku_Base=new RegExp("^"+v+"_media/(.*)");f.media_rewrite_2=/exe\/fetch.php\?media=(.*)/;f.internal_link=/doku.php\?id=(.*)/;f.internal_link_rewrite_2=/doku.php\/(.*)/;f.internal_link_rewrite_1=new RegExp("^"+v+"(?!_media)(.*)");f.samba=/file:\/\/\/\/\/(.*)/;f.samba_unsaved=/^\\\\\w+(\\\w.*)/;var z;defaultFBLang=b.config.defaultFBrowser;var p=b.lang.fbrowser?b.lang.fbrowser:defaultFBLang;var j=function(Q){if(p[Q]&&p[Q]!=""){return p[Q]}return defaultFBLang[Q]};var K=function(){var T=this.getDialog();var V=T.getContentElement("advanced","internalAnchor").getInputElement().$.id;var Q=document.getElementById(V);var S=T.getContentElement("info","internal").getInputElement().$.id;S=document.getElementById(S).value;if(!S){return}var R={push:function(X,W){this.stack[this.Index]=(new Option(X,W,false,false));this.Index++},Index:0,stack:undefined,selection:"",ini:function(W){this.stack=Q.options;this.stack.length=0;this.Index=0;this.push(W,"")}};var U="dw_id="+S;b.config.jquery.post(b.config.ckedit_path+"get_headers.php",U,function(aa,W){if(W=="success"){var ab=decodeURIComponent(aa);if(ab.match(/^\s*__EMPTY__\s*$/)){R.ini("No Headers Found");R.selection="";return}R.ini("Headings Menu");var Z=ab.split("@@");for(var Y in Z){var X=Z[Y].split(/;;/);R.push(X[0],X[1])}}},"html")};var O=function(){return z};var m=function(){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=false;oDokuWiki_FCKEditorInstance.isUrlExtern=false;oDokuWiki_FCKEditorInstance.isDwikiMediaFile=false;var T=this.getDialog(),W=["urlOptions","anchorOptions","emailOptions","internalOptions","mediaOptions","sambaOptions"],V=this.getValue(),U=T.definition.getContents("upload"),Q=U&&U.hidden;T.hidePage("advanced");if(V=="internal"){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=true;T.showPage("advanced")}else{if(V=="media"){oDokuWiki_FCKEditorInstance.isDwikiMediaFile=true}}if(V=="url"){oDokuWiki_FCKEditorInstance.isUrlExtern=true;if(!Q){T.showPage("upload")}}else{if(!Q){T.hidePage("upload")}}for(var S=0;S<W.length;S++){var R=T.getContentElement("info",W[S]);if(!R){continue}R=R.getElement().getParent().getParent();if(W[S]==V+"Options"){R.show()}else{R.hide()}}T.layout()};var G=/^javascript:/,H=/^mailto:([^?]+)(?:\?(.+))?$/,h=/subject=([^;?:@&=$,\/]*)/,P=/body=([^;?:@&=$,\/]*)/,s=/^#(.*)$/,c=/^((?:http|https|ftp|news):\/\/)?(.*)$/,t=/^(_(?:self|top|parent|blank))$/,o=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,E=/^javascript:([^(]+)\(([^)]+)\)$/;var a=/doku.php\?id=(.*)$/;var l=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/;var x=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var n=function(X,U){var R=(U&&(U.data("cke-saved-href")||U.getAttribute("href")))||"",aa,W,V,T,S={};if((aa=R.match(G))){if(k=="encode"){R=R.replace(o,function(ad,af,ae){return"mailto:"+String.fromCharCode.apply(String,af.split(","))+(ae&&r(ae))})}else{if(k){R.replace(E,function(aj,al,ag){if(al==F.name){S.type="email";var ak=S.email={};var ae=/[^,\s]+/g,af=/(^')|('$)/g,ad=ag.match(ae),am=ad.length,ai,an;for(var ah=0;ah<am;ah++){an=decodeURIComponent(r(ad[ah].replace(af,"")));ai=F.params[ah].toLowerCase();ak[ai]=an}ak.address=[ak.name,ak.domain].join("@")}})}}}if(!S.type){if((V=R.match(s))){S.type="anchor";S.anchor={};S.anchor.name=S.anchor.id=V[1]}else{if((W=R.match(H))){var ac=R.match(h),Q=R.match(P);S.type="email";var Z=(S.email={});Z.address=W[1];ac&&(Z.subject=decodeURIComponent(ac[1]));Q&&(Z.body=decodeURIComponent(Q[1]))}else{if((T=R.match(a))||(T=R.match(f.internal_link_rewrite_2))||(T=R.match(f.internal_link_rewrite_1))){S.type="internal";S.url={};S.url.selected=T[1];S.url.protocol="";S.url.url=""}else{if((T=R.match(f.media_internal))||(T=R.match(f.media_rewrite_1))||(T=R.match(f.media_rewrite_2))||(T=R.match(f.media_rewrite_1Doku_Base))){S.type="media";S.url={};S.url.protocol="";S.url.url="";S.url.selected=T[1]}else{if(T=R.match(f.samba)){S.type="samba";S.url={};S.url.url="";S.url.protocol="";S.url.selected="\\\\"+T[1].replace(/\//g,"\\")}else{if(T=R.match(f.samba_unsaved)){S.type="samba";S.url={};S.url.url="";S.url.protocol="";S.url.selected=T[0]}else{if(R&&(T=R.match(c))){S.type="url";S.url={};S.url.protocol=T[1];S.url.url=T[2]}else{S.type="url"}}}}}}}}if(U){var Y=U.getAttribute("target");S.target={};S.adv={};var ab=this}this._.selectedElement=U;return S};var A=function(Q){if(!Q){return}Q=Q.replace(/^[\/\:]/,"");Q=Q.replace(/\//g,":");Q=":"+Q;document.getElementById(fckgInternalInputId).value=Q};update_ckgeditInternalLink=A;var d=function(Q){if(!Q){return}Q=Q.replace(/^[\/\:]/,"");Q=Q.replace(/\//g,":");Q=":"+Q;document.getElementById(fckgMediaInputId).value=Q};update_ckgeditMediaLink=d;var q=function(Q){for(i in Q){msg=i+"="+Q[i];if(!confirm(msg)){break}}};var w=function(R,Q){if(Q[R]){this.setValue(Q[R][this.id]||"")}};var J=function(Q){return w.call(this,"target",Q)};var I=function(Q){return w.call(this,"adv",Q)};var L=function(R,Q){if(!Q[R]){Q[R]={}}Q[R][this.id]=this.getValue()||""};var y=function(Q){return L.call(this,"target",Q)};var M=function(Q){return L.call(this,"adv",Q)};function r(Q){return Q.replace(/\\'/g,"'")}function B(Q){return Q.replace(/'/g,"\\$&")}var k=b.config.emailProtection||"";if(k&&k!="encode"){var F={};k.replace(/^([^(]+)\(([^)]+)\)$/,function(Q,R,S){F.name=R;F.params=[];S.replace(/[^,\s]+/g,function(T){F.params.push(T)})})}function e(S){var Q,R=F.name,W=F.params,U,V;Q=[R,"("];for(var T=0;T<W.length;T++){U=W[T].toLowerCase();V=S[U];T>0&&Q.push(",");Q.push("'",V?B(encodeURIComponent(S[U])):"","'")}Q.push(")");return Q.join("")}function u(R){var Q,U=R.length,S=[];for(var T=0;T<U;T++){Q=R.charCodeAt(T);S.push(Q)}return"String.fromCharCode("+S.join(",")+")"}function D(R){var Q=R.getAttribute("class");return Q?Q.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var C=b.lang.common,g=b.lang.link;return{title:g.title,minWidth:375,minHeight:250,contents:[{id:"info",label:g.info,title:g.info,elements:[{id:"linkType",type:"select",label:g.type,"default":"url",items:[[g.toUrl,"url"],[j("InternalLink"),"internal"],[j("InternalMedia"),"media"],[g.toEmail,"email"],["Samba share","samba"]],onChange:m,setup:function(Q){if(Q.type){this.setValue(Q.type)}},commit:function(Q){Q.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:C.protocol,"default":"http://",items:[["http://\u200E","http://"],["https://\u200E","https://"],["ftp://\u200E","ftp://"],["news://\u200E","news://"]],setup:function(Q){if(Q.url){this.setValue(Q.url.protocol||"")}},commit:function(Q){if(!Q.url){Q.url={}}Q.url.protocol=this.getValue()}},{type:"text",id:"url",label:C.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var S=this.getDialog().getContentElement("info","protocol"),Q=this.getValue(),R=/^(http|https|ftp|news):\/\/(?=.)/i,U=/^((javascript:)|[#\/\.\?])/i;var T=R.exec(Q);if(T){this.setValue(Q.substr(T[0].length));S.setValue(T[0].toLowerCase())}else{if(U.test(Q)){S.setValue("")}}this.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var Q=this.getDialog();if(Q.getContentElement("info","linkType")&&Q.getValueOf("info","linkType")!="url"){return true}if(this.getDialog().fakeObj){return true}var R=CKEDITOR.dialog.validate.notEmpty(g.noUrl);return R.apply(this)},setup:function(Q){this.allowOnChange=false;if(Q.url){this.setValue(Q.url.url)}this.allowOnChange=true},commit:function(Q){this.onChange();if(!Q.url){Q.url={}}Q.url.url=this.getValue();this.allowOnChange=false}}],setup:function(Q){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().show()}}},{type:"button",id:"browse0",filebrowser:"info:url",label:C.browseServer},]},{type:"vbox",id:"internalOptions",children:[{type:"button",id:"browse1",hidden:"true",filebrowser:"info:url",label:C.browseServer},{type:"text",id:"internal",label:j("InternalLink"),required:true,setup:function(Q){if(Q){if(Q.url&&Q.url.selected){var R=Q.url.selected.replace(/^\:/,"");this.setValue(":"+R)}}},},{id:"anchorsmsg",type:"html",html:j("AdvancedTabPrompt"),}]},{type:"vbox",id:"mediaOptions",children:[{type:"button",id:"browse2",filebrowser:"info:url",label:C.browseServer},{type:"text",id:"media",label:j("MediaFileLink"),required:true,setup:function(Q){if(Q){if(Q.url&&Q.url.selected){var R=Q.url.selected.replace(/^\:/,"");this.setValue(":"+R)}}},},]},{type:"vbox",id:"sambaOptions",children:[{type:"html",id:"smb_msg",html:j("SMBExample"),},{type:"text",id:"samba",width:"50",label:j("SMBLabel"),required:true,setup:function(Q){if(Q.url&&Q.url.selected){this.setValue(Q.url.selected)}},},]},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:g.emailAddress,required:true,validate:function(){var Q=this.getDialog();if(!Q.getContentElement("info","linkType")||Q.getValueOf("info","linkType")!="email"){return true}var R=CKEDITOR.dialog.validate.notEmpty(g.noEmail);return R.apply(this)},setup:function(R){if(R.email){this.setValue(R.email.address)}var Q=this.getDialog().getContentElement("info","linkType");if(Q&&Q.getValue()=="email"){this.select()}},commit:function(Q){if(!Q.email){Q.email={}}Q.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:g.emailSubject,setup:function(Q){if(Q.email){this.setValue(Q.email.subject)}},commit:function(Q){if(!Q.email){Q.email={}}Q.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:g.emailBody,rows:3,"default":"",setup:function(Q){if(Q.email){this.setValue(Q.email.body)}},commit:function(Q){if(!Q.email){Q.email={}}Q.email.body=this.getValue()}}],setup:function(Q){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}}]},{id:"upload",label:g.upload,title:g.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:C.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:C.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:g.advanced,title:g.advanced,elements:[{id:"msg",type:"html",html:"<p style='max-width:350px; white-space: pre-wrap;'>"+j("AdvancedInfo")+"</p>"},{id:"internalAnchor",type:"select","default":"",items:[["Not Set",""],],setup:function(Q){if(Q.hash){this.setValue(Q.hash)}},commit:function(Q){Q.hash=this.getValue()}},{type:"button",id:"getheaders",onClick:K,label:j("GetHeadingsLabel"),},{type:"html",html:"<br />",},{type:"text",id:"queryString",label:j("QStringLabel"),setup:function(Q){if(Q.qstring){this.setValue(Q.qstring)}},commit:function(Q){Q.qstring=this.getValue()}},{type:"button",id:"clearquerystring",onClick:function(){var R=this.getDialog();var S=R.getContentElement("advanced","queryString").getInputElement().$.id;var Q=document.getElementById(S);Q.value=""},label:j("ResetQS"),},{type:"vbox",padding:1,hidden:true,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:g.cssClasses,"default":"",id:"advCSSClasses",setup:I,commit:M},{type:"text",label:g.charset,"default":"",id:"advCharset",setup:I,commit:M}]},]}]}],onShow:function(){var S=this.getParentEditor(),R=S.getSelection(),Q=null;if((Q=N.getSelectedLink(S))&&Q.hasAttribute("href")){R.selectElement(Q)}else{Q=null}this.setupContent(n.apply(this,[S,Q]))},onOk:function(){var Y=new RegExp(oDokuWiki_FCKEditorInstance.imageUploadAllowedExtensions);var aa={},T=[],ao={},an=this,V=this.getParentEditor();this.commitContent(ao);var aj=false;switch(ao.type||"url"){case"media":if(document.getElementById(fckgMediaInputId).value){ao.url.url=document.getElementById(fckgMediaInputId).value}ao.adv.advTitle=ao.url.url;var am=ao.url.url.match(/(\.(\w+))$/);ao.url.url=V.config.doku_url+"doku.php?id="+ao.url.url;if(am[1].match(Y)){ao.adv.advContentType="linkonly"}else{ao.adv.advContentType="other_mime";aj=true}ao.adv.advCSSClasses="media mediafile";if(am){ao.adv.advCSSClasses+=" mf_"+am[2]}var ae=(ao.url&&ao.url.protocol!=undefined)?ao.url.protocol:"http://",W=(ao.url&&CKEDITOR.tools.trim(ao.url.url))||"";aa["data-cke-saved-href"]=(W.indexOf("/")===0)?W:ae+W;break;case"internal":if(!ao.url.url){ao.url.url=document.getElementById(fckgInternalInputId).value}ao.url.url=ao.url.url.replace(/^.*?\/data\/pages\//,"");ao.url.url=ao.url.url.replace(/^\:/,"");ao.url.url=":"+ao.url.url.replace(/\//g,":");ao.adv.advCSSClasses="wikilink1";ao.adv.advTitle=ao.url.url;ao.url.url=V.config.doku_url+"doku.php?id="+ao.url.url;if(ao.hash){ao.url.url+="#"+ao.hash}if(ao.qstring){ao.url.url+="&"+ao.qstring}case"url":var ae=(ao.url&&ao.url.protocol!=undefined)?ao.url.protocol:"http://",W=(ao.url&&CKEDITOR.tools.trim(ao.url.url))||"";aa["data-cke-saved-href"]=(W.indexOf("/")===0)?W:ae+W;break;case"anchor":var aq=(ao.anchor&&ao.anchor.name),af=(ao.anchor&&ao.anchor.id);aa["data-cke-saved-href"]="#"+(aq||af||"");break;case"samba":if(!ao.url.url){ao.url.url=document.getElementById(O()).value}if(!ao.url.url){alert("Missing Samba Url");return false}ao.url.protocol="";var ae="";W=(ao.url&&CKEDITOR.tools.trim(ao.url.url))||"";aa["data-cke-saved-href"]=(W.indexOf("/")===0)?W:ae+W;ao.adv.advCSSClasses="windows";ao.adv.advTitle=ao.url.url;break;case"email":var S,ah=ao.email,U=ah.address;switch(k){case"":case"encode":var X=encodeURIComponent(ah.subject||""),ab=encodeURIComponent(ah.body||"");var Z=[];X&&Z.push("subject="+X);ab&&Z.push("body="+ab);Z=Z.length?"?"+Z.join("&"):"";if(k=="encode"){S=["javascript:void(location.href='mailto:'+",u(U)];Z&&S.push("+'",B(Z),"'");S.push(")")}else{S=["mailto:",U,Z]}break;default:var ag=U.split("@",2);ah.name=ag[0];ah.domain=ag[1];S=["javascript:",e(ah)]}aa["data-cke-saved-href"]=S.join("");break}if(ao.adv){var ai=function(ar,at){var au=ao.adv[ar];if(au){aa[at]=au}else{T.push(at)}};ai("advId","id");ai("advLangDir","dir");ai("advAccessKey","accessKey");if(ao.adv.advName){aa.name=aa["data-cke-saved-name"]=ao.adv.advName}else{T=T.concat(["data-cke-saved-name","name"])}ai("advLangCode","lang");ai("advTabIndex","tabindex");if(!aj){ai("advTitle","title")}ai("advContentType","type");ai("advCSSClasses","class");ai("advCharset","charset");ai("advStyles","style");ai("advRel","rel")}var ap=V.getSelection();aa.href=aa["data-cke-saved-href"];if(!this._.selectedElement){var R=ap.getRanges(true);if(R.length==1&&R[0].collapsed){var ad=new CKEDITOR.dom.text(ao.type=="email"?ao.email.address:aa["data-cke-saved-href"],V.document);R[0].insertNode(ad);R[0].selectNodeContents(ad);ap.selectRanges(R)}var al=new CKEDITOR.style({element:"a",attributes:aa});al.type=CKEDITOR.STYLE_INLINE;al.apply(V.document)}else{var Q=this._.selectedElement,ak=Q.data("cke-saved-href"),ac=Q.getHtml();Q.setAttributes(aa);Q.removeAttributes(T);if(ao.adv&&ao.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector){Q.addClass(Q.getChildCount()?"cke_anchor":"cke_anchor_empty")}if(ak==ac||ao.type=="email"&&ac.indexOf("@")!=-1){Q.setHtml(ao.type=="email"?ao.email.address:aa["data-cke-saved-href"])}ap.selectElement(Q);delete this._.selectedElement}if(ad&&ao.adv.advTitle){ad.setText(ao.adv.advTitle)}},onLoad:function(){oDokuWiki_FCKEditorInstance.isDwikiImage=false;fckgInternalInputId=this.getContentElement("info","internal").getInputElement().$.id;fckgMediaInputId=this.getContentElement("info","media").getInputElement().$.id;z=this.getContentElement("info","samba").getInputElement().$.id;this.hidePage("advanced");this.showPage("info");var R=this._.tabs.advanced&&this._.tabs.advanced[0];var Q=this;var S=j("NotSetOption");R.on("focus",function(U){var V=Q.getContentElement("advanced","internalAnchor").getInputElement().$.id;var T=document.getElementById(V);T.selectedIndex=-1;T.options.length=0;T.options[0]=new Option(S,"",false,false)})},onFocus:function(){var Q=this.getContentElement("info","linkType"),R;if(Q&&Q.getValue()=="url"){R=this.getContentElement("info","url");R.select()}}}});