var update_ckgeditInternalLink,update_ckgeditMediaLink;var fckgInternalInputId,fckgMediaInputId;window.onbeforeunload=function(){};CKEDITOR.dialog.add("link",function(b){oDokuWiki_FCKEditorInstance.Lang=b.lang;var t=oDokuWiki_FCKEditorInstance.dwiki_doku_base;var L=CKEDITOR.plugins.link;var f=new Object();f.doku_base=new RegExp("^"+t.replace(/\//g,"\\/"),"g");f.media_internal=/lib\/exe\/fetch\.php\/(.*)/;f.media_rewrite_1=/^_media\/(.*)/;f.media_rewrite_1Doku_Base=new RegExp("^"+t+"_media/(.*)");f.media_rewrite_2=/exe\/fetch.php\?media=(.*)/;f.internal_link=/doku.php\?id=(.*)/;f.internal_link_rewrite_2=/doku.php\/(.*)/;f.internal_link_rewrite_1=new RegExp("^"+t+"(?!_media)(.*)");f.samba=/file:\/\/\/\/\/(.*)/;f.samba_unsaved=/^\\\\\w+(\\\w.*)/;var x;var I=function(){var R=this.getDialog();var T=R.getContentElement("advanced","internalAnchor").getInputElement().$.id;var O=document.getElementById(T);var Q=R.getContentElement("info","internal").getInputElement().$.id;Q=document.getElementById(Q).value;if(!Q){return}var P={push:function(V,U){this.stack[this.Index]=(new Option(V,U,false,false));this.Index++},Index:0,stack:undefined,selection:"",ini:function(U){this.stack=O.options;this.stack.length=0;this.Index=0;this.push(U,"")}};var S="dw_id="+Q;b.config.jquery.post(b.config.ckedit_path+"get_headers.php",S,function(Y,U){if(U=="success"){var Z=decodeURIComponent(Y);if(Z.match(/^\s*__EMPTY__\s*$/)){P.ini("No Headers Found");P.selection="";return}P.ini("Headings Menu");var X=Z.split("@@");for(var W in X){var V=X[W].split(/;;/);P.push(V[0],V[1])}}},"html")};var M=function(){return x};var l=function(){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=false;oDokuWiki_FCKEditorInstance.isUrlExtern=false;oDokuWiki_FCKEditorInstance.isDwikiMediaFile=false;var R=this.getDialog(),U=["urlOptions","anchorOptions","emailOptions","internalOptions","mediaOptions","sambaOptions"],T=this.getValue(),S=R.definition.getContents("upload"),O=S&&S.hidden;R.hidePage("advanced");if(T=="internal"){oDokuWiki_FCKEditorInstance.isLocalDwikiBrowser=true;R.showPage("advanced")}else{if(T=="media"){oDokuWiki_FCKEditorInstance.isDwikiMediaFile=true}}if(T=="url"){oDokuWiki_FCKEditorInstance.isUrlExtern=true;if(!O){R.showPage("upload")}}else{if(!O){R.hidePage("upload")}}for(var Q=0;Q<U.length;Q++){var P=R.getContentElement("info",U[Q]);if(!P){continue}P=P.getElement().getParent().getParent();if(U[Q]==T+"Options"){P.show()}else{P.hide()}}R.layout()};var E=/^javascript:/,F=/^mailto:([^?]+)(?:\?(.+))?$/,h=/subject=([^;?:@&=$,\/]*)/,N=/body=([^;?:@&=$,\/]*)/,q=/^#(.*)$/,c=/^((?:http|https|ftp|news):\/\/)?(.*)$/,r=/^(_(?:self|top|parent|blank))$/,n=/^javascript:void\(location\.href='mailto:'\+String\.fromCharCode\(([^)]+)\)(?:\+'(.*)')?\)$/,C=/^javascript:([^(]+)\(([^)]+)\)$/;var a=/doku.php\?id=(.*)$/;var k=/\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*/;var v=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var m=function(V,S){var P=(S&&(S.data("cke-saved-href")||S.getAttribute("href")))||"",Y,U,T,R,Q={};if((Y=P.match(E))){if(j=="encode"){P=P.replace(n,function(ab,ad,ac){return"mailto:"+String.fromCharCode.apply(String,ad.split(","))+(ac&&p(ac))})}else{if(j){P.replace(C,function(ah,aj,ae){if(aj==D.name){Q.type="email";var ai=Q.email={};var ac=/[^,\s]+/g,ad=/(^')|('$)/g,ab=ae.match(ac),ak=ab.length,ag,al;for(var af=0;af<ak;af++){al=decodeURIComponent(p(ab[af].replace(ad,"")));ag=D.params[af].toLowerCase();ai[ag]=al}ai.address=[ai.name,ai.domain].join("@")}})}}}if(!Q.type){if((T=P.match(q))){Q.type="anchor";Q.anchor={};Q.anchor.name=Q.anchor.id=T[1]}else{if((U=P.match(F))){var aa=P.match(h),O=P.match(N);Q.type="email";var X=(Q.email={});X.address=U[1];aa&&(X.subject=decodeURIComponent(aa[1]));O&&(X.body=decodeURIComponent(O[1]))}else{if((R=P.match(a))||(R=P.match(f.internal_link_rewrite_2))||(R=P.match(f.internal_link_rewrite_1))){Q.type="internal";Q.url={};Q.url.selected=R[1];Q.url.protocol="";Q.url.url=""}else{if((R=P.match(f.media_internal))||(R=P.match(f.media_rewrite_1))||(R=P.match(f.media_rewrite_2))||(R=P.match(f.media_rewrite_1Doku_Base))){Q.type="media";Q.url={};Q.url.protocol="";Q.url.url="";Q.url.selected=R[1]}else{if(R=P.match(f.samba)){Q.type="samba";Q.url={};Q.url.url="";Q.url.protocol="";Q.url.selected="\\\\"+R[1].replace(/\//g,"\\")}else{if(R=P.match(f.samba_unsaved)){Q.type="samba";Q.url={};Q.url.url="";Q.url.protocol="";Q.url.selected=R[0]}else{if(P&&(R=P.match(c))){Q.type="url";Q.url={};Q.url.protocol=R[1];Q.url.url=R[2]}else{Q.type="url"}}}}}}}}if(S){var W=S.getAttribute("target");Q.target={};Q.adv={};var Z=this}this._.selectedElement=S;return Q};var y=function(O){if(!O){return}O=O.replace(/^[\/\:]/,"");O=O.replace(/\//g,":");O=":"+O;document.getElementById(fckgInternalInputId).value=O};update_ckgeditInternalLink=y;var d=function(O){if(!O){return}O=O.replace(/^[\/\:]/,"");O=O.replace(/\//g,":");O=":"+O;document.getElementById(fckgMediaInputId).value=O};update_ckgeditMediaLink=d;var o=function(O){for(i in O){msg=i+"="+O[i];if(!confirm(msg)){break}}};var u=function(P,O){if(O[P]){this.setValue(O[P][this.id]||"")}};var H=function(O){return u.call(this,"target",O)};var G=function(O){return u.call(this,"adv",O)};var J=function(P,O){if(!O[P]){O[P]={}}O[P][this.id]=this.getValue()||""};var w=function(O){return J.call(this,"target",O)};var K=function(O){return J.call(this,"adv",O)};function p(O){return O.replace(/\\'/g,"'")}function z(O){return O.replace(/'/g,"\\$&")}var j=b.config.emailProtection||"";if(j&&j!="encode"){var D={};j.replace(/^([^(]+)\(([^)]+)\)$/,function(O,P,Q){D.name=P;D.params=[];Q.replace(/[^,\s]+/g,function(R){D.params.push(R)})})}function e(Q){var O,P=D.name,U=D.params,S,T;O=[P,"("];for(var R=0;R<U.length;R++){S=U[R].toLowerCase();T=Q[S];R>0&&O.push(",");O.push("'",T?z(encodeURIComponent(Q[S])):"","'")}O.push(")");return O.join("")}function s(P){var O,S=P.length,Q=[];for(var R=0;R<S;R++){O=P.charCodeAt(R);Q.push(O)}return"String.fromCharCode("+Q.join(",")+")"}function B(P){var O=P.getAttribute("class");return O?O.replace(/\s*(?:cke_anchor_empty|cke_anchor)(?:\s*$)?/g,""):""}var A=b.lang.common,g=b.lang.link;return{title:g.title,minWidth:375,minHeight:250,contents:[{id:"info",label:g.info,title:g.info,elements:[{id:"linkType",type:"select",label:g.type,"default":"url",items:[[g.toUrl,"url"],["internal link","internal"],["internal media","media"],[g.toEmail,"email"],["Samba share","samba"]],onChange:l,setup:function(O){if(O.type){this.setValue(O.type)}},commit:function(O){O.type=this.getValue()}},{type:"vbox",id:"urlOptions",children:[{type:"hbox",widths:["25%","75%"],children:[{id:"protocol",type:"select",label:A.protocol,"default":"http://",items:[["http://\u200E","http://"],["https://\u200E","https://"],["ftp://\u200E","ftp://"],["news://\u200E","news://"]],setup:function(O){if(O.url){this.setValue(O.url.protocol||"")}},commit:function(O){if(!O.url){O.url={}}O.url.protocol=this.getValue()}},{type:"text",id:"url",label:A.url,required:true,onLoad:function(){this.allowOnChange=true},onKeyUp:function(){this.allowOnChange=false;var Q=this.getDialog().getContentElement("info","protocol"),O=this.getValue(),P=/^(http|https|ftp|news):\/\/(?=.)/i,S=/^((javascript:)|[#\/\.\?])/i;var R=P.exec(O);if(R){this.setValue(O.substr(R[0].length));Q.setValue(R[0].toLowerCase())}else{if(S.test(O)){Q.setValue("")}}this.allowOnChange=true},onChange:function(){if(this.allowOnChange){this.onKeyUp()}},validate:function(){var O=this.getDialog();if(O.getContentElement("info","linkType")&&O.getValueOf("info","linkType")!="url"){return true}if(this.getDialog().fakeObj){return true}var P=CKEDITOR.dialog.validate.notEmpty(g.noUrl);return P.apply(this)},setup:function(O){this.allowOnChange=false;if(O.url){this.setValue(O.url.url)}this.allowOnChange=true},commit:function(O){this.onChange();if(!O.url){O.url={}}O.url.url=this.getValue();this.allowOnChange=false}}],setup:function(O){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().show()}}},{type:"button",id:"browse0",filebrowser:"info:url",label:A.browseServer},]},{type:"vbox",id:"internalOptions",children:[{type:"button",id:"browse1",hidden:"true",filebrowser:"info:url",label:A.browseServer},{type:"text",id:"internal",label:"internal link",required:true,setup:function(O){if(O){if(O.url&&O.url.selected){var P=O.url.selected.replace(/^\:/,"");this.setValue(":"+P)}}},},{id:"anchorsmsg",type:"html",html:"Use the advanced tab to create page anchors and query strings",}]},{type:"vbox",id:"mediaOptions",children:[{type:"button",id:"browse2",filebrowser:"info:url",label:A.browseServer},{type:"text",id:"media",label:"link to media file",required:true,setup:function(O){if(O){if(O.url&&O.url.selected){var P=O.url.selected.replace(/^\:/,"");this.setValue(":"+P)}}},},]},{type:"vbox",id:"sambaOptions",children:[{type:"html",id:"smb_msg",html:"Enter your share as: \\\\Server\\directory\\file",},{type:"text",id:"samba",width:"50",label:"Samba Share",required:true,setup:function(O){if(O.url&&O.url.selected){this.setValue(O.url.selected)}},},]},{type:"vbox",id:"emailOptions",padding:1,children:[{type:"text",id:"emailAddress",label:g.emailAddress,required:true,validate:function(){var O=this.getDialog();if(!O.getContentElement("info","linkType")||O.getValueOf("info","linkType")!="email"){return true}var P=CKEDITOR.dialog.validate.notEmpty(g.noEmail);return P.apply(this)},setup:function(P){if(P.email){this.setValue(P.email.address)}var O=this.getDialog().getContentElement("info","linkType");if(O&&O.getValue()=="email"){this.select()}},commit:function(O){if(!O.email){O.email={}}O.email.address=this.getValue()}},{type:"text",id:"emailSubject",label:g.emailSubject,setup:function(O){if(O.email){this.setValue(O.email.subject)}},commit:function(O){if(!O.email){O.email={}}O.email.subject=this.getValue()}},{type:"textarea",id:"emailBody",label:g.emailBody,rows:3,"default":"",setup:function(O){if(O.email){this.setValue(O.email.body)}},commit:function(O){if(!O.email){O.email={}}O.email.body=this.getValue()}}],setup:function(O){if(!this.getDialog().getContentElement("info","linkType")){this.getElement().hide()}}}]},{id:"upload",label:g.upload,title:g.upload,hidden:true,filebrowser:"uploadButton",elements:[{type:"file",id:"upload",label:A.upload,style:"height:40px",size:29},{type:"fileButton",id:"uploadButton",label:A.uploadSubmit,filebrowser:"info:url","for":["upload","upload"]}]},{id:"advanced",label:g.advanced,title:g.advanced,elements:[{id:"msg",type:"html",html:"<p style='max-width:350px; white-space: pre-wrap;'>To create anchors from Dokuwiki headers, click on the Get Headings button, select the header, click OK. You can go back, select a new page and get new headers.</p>"},{id:"internalAnchor",type:"select","default":"",items:[["Not Set",""],],setup:function(O){if(O.hash){this.setValue(O.hash)}},commit:function(O){O.hash=this.getValue()}},{type:"button",id:"getheaders",onClick:I,label:"Get Headings"},{type:"html",html:"<br />",},{type:"text",id:"queryString",label:"Query String (For example: value_1=1&value_2=2) ",setup:function(O){if(O.qstring){this.setValue(O.qstring)}},commit:function(O){O.qstring=this.getValue()}},{type:"button",id:"clearquerystring",onClick:function(){var P=this.getDialog();var Q=P.getContentElement("advanced","queryString").getInputElement().$.id;var O=document.getElementById(Q);O.value=""},label:"Reset Query String"},{type:"vbox",padding:1,hidden:true,children:[{type:"hbox",widths:["45%","55%"],children:[{type:"text",label:g.cssClasses,"default":"",id:"advCSSClasses",setup:G,commit:K},{type:"text",label:g.charset,"default":"",id:"advCharset",setup:G,commit:K}]},]}]}],onShow:function(){var Q=this.getParentEditor(),P=Q.getSelection(),O=null;if((O=L.getSelectedLink(Q))&&O.hasAttribute("href")){P.selectElement(O)}else{O=null}this.setupContent(m.apply(this,[Q,O]))},onOk:function(){var W=new RegExp(oDokuWiki_FCKEditorInstance.imageUploadAllowedExtensions);var Y={},R=[],am={},al=this,T=this.getParentEditor();this.commitContent(am);var ah=false;switch(am.type||"url"){case"media":if(document.getElementById(fckgMediaInputId).value){am.url.url=document.getElementById(fckgMediaInputId).value}am.adv.advTitle=am.url.url;var ak=am.url.url.match(/(\.(\w+))$/);am.url.url=T.config.doku_url+"doku.php?id="+am.url.url;if(ak[1].match(W)){am.adv.advContentType="linkonly"}else{am.adv.advContentType="other_mime";ah=true}am.adv.advCSSClasses="media mediafile";if(ak){am.adv.advCSSClasses+=" mf_"+ak[2]}var ac=(am.url&&am.url.protocol!=undefined)?am.url.protocol:"http://",U=(am.url&&CKEDITOR.tools.trim(am.url.url))||"";Y["data-cke-saved-href"]=(U.indexOf("/")===0)?U:ac+U;break;case"internal":if(!am.url.url){am.url.url=document.getElementById(fckgInternalInputId).value}am.url.url=am.url.url.replace(/^.*?\/data\/pages\//,"");am.url.url=am.url.url.replace(/^\:/,"");am.url.url=":"+am.url.url.replace(/\//g,":");am.adv.advCSSClasses="wikilink1";am.adv.advTitle=am.url.url;am.url.url=T.config.doku_url+"doku.php?id="+am.url.url;if(am.hash){am.url.url+="#"+am.hash}if(am.qstring){am.url.url+="&"+am.qstring}case"url":var ac=(am.url&&am.url.protocol!=undefined)?am.url.protocol:"http://",U=(am.url&&CKEDITOR.tools.trim(am.url.url))||"";Y["data-cke-saved-href"]=(U.indexOf("/")===0)?U:ac+U;break;case"anchor":var ao=(am.anchor&&am.anchor.name),ad=(am.anchor&&am.anchor.id);Y["data-cke-saved-href"]="#"+(ao||ad||"");break;case"samba":if(!am.url.url){am.url.url=document.getElementById(M()).value}if(!am.url.url){alert("Missing Samba Url");return false}am.url.protocol="";var ac="";U=(am.url&&CKEDITOR.tools.trim(am.url.url))||"";Y["data-cke-saved-href"]=(U.indexOf("/")===0)?U:ac+U;am.adv.advCSSClasses="windows";am.adv.advTitle=am.url.url;break;case"email":var Q,af=am.email,S=af.address;switch(j){case"":case"encode":var V=encodeURIComponent(af.subject||""),Z=encodeURIComponent(af.body||"");var X=[];V&&X.push("subject="+V);Z&&X.push("body="+Z);X=X.length?"?"+X.join("&"):"";if(j=="encode"){Q=["javascript:void(location.href='mailto:'+",s(S)];X&&Q.push("+'",z(X),"'");Q.push(")")}else{Q=["mailto:",S,X]}break;default:var ae=S.split("@",2);af.name=ae[0];af.domain=ae[1];Q=["javascript:",e(af)]}Y["data-cke-saved-href"]=Q.join("");break}if(am.adv){var ag=function(ap,aq){var ar=am.adv[ap];if(ar){Y[aq]=ar}else{R.push(aq)}};ag("advId","id");ag("advLangDir","dir");ag("advAccessKey","accessKey");if(am.adv.advName){Y.name=Y["data-cke-saved-name"]=am.adv.advName}else{R=R.concat(["data-cke-saved-name","name"])}ag("advLangCode","lang");ag("advTabIndex","tabindex");if(!ah){ag("advTitle","title")}ag("advContentType","type");ag("advCSSClasses","class");ag("advCharset","charset");ag("advStyles","style");ag("advRel","rel")}var an=T.getSelection();Y.href=Y["data-cke-saved-href"];if(!this._.selectedElement){var P=an.getRanges(true);if(P.length==1&&P[0].collapsed){var ab=new CKEDITOR.dom.text(am.type=="email"?am.email.address:Y["data-cke-saved-href"],T.document);P[0].insertNode(ab);P[0].selectNodeContents(ab);an.selectRanges(P)}var aj=new CKEDITOR.style({element:"a",attributes:Y});aj.type=CKEDITOR.STYLE_INLINE;aj.apply(T.document)}else{var O=this._.selectedElement,ai=O.data("cke-saved-href"),aa=O.getHtml();O.setAttributes(Y);O.removeAttributes(R);if(am.adv&&am.adv.advName&&CKEDITOR.plugins.link.synAnchorSelector){O.addClass(O.getChildCount()?"cke_anchor":"cke_anchor_empty")}if(ai==aa||am.type=="email"&&aa.indexOf("@")!=-1){O.setHtml(am.type=="email"?am.email.address:Y["data-cke-saved-href"])}an.selectElement(O);delete this._.selectedElement}if(ab&&am.adv.advTitle){ab.setText(am.adv.advTitle)}},onLoad:function(){oDokuWiki_FCKEditorInstance.isDwikiImage=false;fckgInternalInputId=this.getContentElement("info","internal").getInputElement().$.id;fckgMediaInputId=this.getContentElement("info","media").getInputElement().$.id;x=this.getContentElement("info","samba").getInputElement().$.id;this.hidePage("advanced");this.showPage("info");var P=this._.tabs.advanced&&this._.tabs.advanced[0];var O=this;P.on("focus",function(R){var S=O.getContentElement("advanced","internalAnchor").getInputElement().$.id;var Q=document.getElementById(S);Q.selectedIndex=-1;Q.options.length=0;Q.options[0]=new Option("Not set","",false,false);alert(data.hash)})},onFocus:function(){var O=this.getContentElement("info","linkType"),P;if(O&&O.getValue()=="url"){P=this.getContentElement("info","url");P.select()}}}});